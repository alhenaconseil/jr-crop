/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version 1.0.0
 * @link https://github.com/JrSchild/jr-crop
 * @author Joram Ruitenschild
 * @license MIT
 */
angular.module("jrCrop",[]).factory("$jrCrop",["$ionicModal","$ionicLoading","$rootScope","$q",function(i,t,e,s){var o='<div class="jr-crop modal"><div class="bar bar-header bar-positive"><h1 class="title">{{title}}</h1></div><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><footer class="footer"><nav class="tabs tabs-icon-only tabs-positive"><a class="tab-item" ng-click="cancel()"><i class="ion-close-round"></i></a><a class="tab-item" ng-click="crop()"><i class="ion-checkmark-round"></i></a></nav></footer></div>',a=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,last_scale:1,last_posX:0,last_posY:0,initialize:function(i){var t=this;t.options=i,t.promise=s.defer(),t.loadImage().then(function(i){t.imgWidth=i.naturalWidth,t.imgHeight=i.naturalHeight,t.options.modal.el.querySelector(".jr-crop-img").appendChild(t.imgSelect=i.cloneNode()),t.options.modal.el.querySelector(".jr-crop-select").appendChild(t.imgFull=i.cloneNode()),t.bindHandlers(),t.initImage()}),t.options.cancel=this.cancel.bind(this),t.options.crop=this.crop.bind(this)},initImage:function(){if(this.options.height<this.imgHeight||this.options.width<this.imgWidth){var i=this.imgWidth/this.imgHeight,t=this.options.width/this.options.height;this.scale=this.last_scale=t>i?this.options.width/this.imgWidth:this.options.height/this.imgHeight}var e=(this.imgWidth-this.options.width)/2,s=(this.imgHeight-this.options.height)/2;this.posX=this.last_posX=-e,this.posY=this.last_posY=-s,this.setImageTransform()},cancel:function(){var i=this;i.options.modal.remove().then(function(){i.promise.reject("canceled")})},bindHandlers:function(){function i(){t(),s.posX>o&&(s.posX=o),s.posX<n&&(s.posX=n),s.posY>a&&(s.posY=a),s.posY<h&&(s.posY=h)}function t(){var i=s.scale*s.imgWidth,t=s.scale*s.imgHeight;o=(i-s.imgWidth)/2,a=(t-s.imgHeight)/2,n=-(i-o-s.options.width),h=-(t-a-s.options.height)}var e,s=this,o=0,a=0,n=0,h=0,l=0,r=0,c=1,d=s.imgWidth/s.imgHeight,p=s.options.width/s.options.height;e=d>p?s.options.height/s.imgHeight:s.options.width/s.imgWidth;var g={prevent_default_directions:["left","right","up","down"]};ionic.onGesture("touch transform drag dragstart dragend",function(t){switch(t.type){case"touch":s.last_scale=s.scale;break;case"drag":s.posX=s.last_posX+t.gesture.deltaX-l,s.posY=s.last_posY+t.gesture.deltaY-r,i();break;case"transform":s.scale=Math.max(e,Math.min(s.last_scale*t.gesture.scale,c)),i();break;case"dragend":s.last_posX=s.posX,s.last_posY=s.posY;break;case"dragstart":s.last_scale=s.scale,t.gesture.deltaX>1||t.gesture.deltaX<-1?(l=t.gesture.deltaX,r=t.gesture.deltaY):(l=0,r=0)}s.setImageTransform()},s.options.modal.el,g)},setImageTransform:function(){var i=this,t="translate3d("+i.posX+"px,"+i.posY+"px, 0) scale3d("+i.scale+","+i.scale+", 1)";i.imgSelect.style[ionic.CSS.TRANSFORM]=t,i.imgFull.style[ionic.CSS.TRANSFORM]=t},crop:function(){t.show();var i=document.createElement("canvas"),e=i.getContext("2d");i.width=this.options.width/this.scale,i.height=this.options.height/this.scale;var s=this.imgWidth*this.scale,o=this.imgHeight*this.scale,a=(s-this.imgWidth)/2,n=(o-this.imgHeight)/2,h=(this.posX-a)/this.scale,l=(this.posY-n)/this.scale;e.drawImage(this.imgFull,h,l),this.options.modal.remove(),this.promise.resolve(i),this.promise.promise.then(function(){t.hide()})},loadImage:function(){var i=s.defer();return angular.element("<img />").bind("load",function(t){i.resolve(this)}).bind("error",i.reject).prop("src",this.options.url),i.promise}});return{defaultOptions:{width:0,height:0,aspectRatio:1,cancelText:"Cancel",chooseText:"Choose"},crop:function(t){t=this.initOptions(t);var s=e.$new(!0);return ionic.extend(s,t),s.modal=i.fromTemplate(o,{scope:s}),s.modal.show().then(function(){return new a(s).promise.promise})},initOptions:function(i){var t;return t=ionic.extend({},this.defaultOptions),t=ionic.extend(t,i),t.aspectRatio&&(t.width||t.height||(t.width=200),t.width?t.height=t.width/t.aspectRatio:t.height&&(t.width=t.height*t.aspectRatio)),t}}}]);